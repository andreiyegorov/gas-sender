/*******************************************************
 *  üí∞ SBER OPERATIONS PARSER (v5)
 *  üìÖ –í–µ—Ä—Å–∏—è: 2611-0035 (26 –Ω–æ—è–±—Ä—è 00:35)
 *  üìò –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
 *     –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∏—Å—å–º–∞ –æ—Ç –°–±–µ—Ä–ë–∏–∑–Ω–µ—Å –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
 *     –≤ –ª–∏—Å—Ç "SB_operations" (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É).
 *  üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è:
 *     ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—è "–ë–∞–ª–∞–Ω—Å"
 *     ‚Ä¢ –°–ø–∏—Å–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ
 *******************************************************/

/*******************************************************
 * 1Ô∏è‚É£ –ö–û–ù–°–¢–ê–ù–¢–´
 *******************************************************/
var SB_SHEET = 'SB_operations';

/*******************************************************
 * 2Ô∏è‚É£ –ó–ê–ü–£–°–ö –ò–ó –ú–ï–ù–Æ
 *******************************************************/
function parseSberOperations() {
  parseSberOperations_('manual');
}

/*******************************************************
 * 3Ô∏è‚É£ –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
 *******************************************************/
function parseSberOperations_(source) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sh = ss.getSheetByName(SB_SHEET);
  if (!sh) {
    sh = ss.insertSheet(SB_SHEET);
    sh.appendRow(['–î–∞—Ç–∞ –ø–∏—Å—å–º–∞','–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏','–ö–æ–º–ø–∞–Ω–∏—è','–ò–ù–ù','–†/–°','‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞','–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞','–°—É–º–º–∞','–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ','–ë–∞–ª–∞–Ω—Å']);
  }

  /*******************
   * 3.1 –ü–æ–∏—Å–∫ –ø–∏—Å–µ–º
   *******************/
  const threads = GmailApp.search('subject:(–æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —Å—á—ë—Ç—É) newer_than:14d');
  const tz = Session.getScriptTimeZone();

  /*******************
   * 3.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∏—Å–µ–º
   *******************/
  for (let t = threads.length - 1; t >= 0; t--) {
    const thread = threads[t];
    const msgs = thread.getMessages();

    for (let m = 0; m < msgs.length; m++) {
      const msg = msgs[m];
      const body = msg.getPlainBody();
      if (!body) continue;

      const dateStr = Utilities.formatDate(msg.getDate(), tz, 'dd.MM.yy HH:mm');
      const type = body.includes('–ø–æ—Å—Ç—É–ø–∏–ª–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞') ? '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ' :
                   body.includes('—Å–ø–∏—Å–∞–Ω—ã —Å—Ä–µ–¥—Å—Ç–≤–∞') ? '–°–ø–∏—Å–∞–Ω–∏–µ' : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ';

      /*******************
       * 3.3 –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è / –ø–æ–ª—É—á–∞—Ç–µ–ª—è
       *******************/
      const senderMatch = body.match(/(–ö—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å|–ö—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å)\?\s*([\s\S]*?)(?:–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:|–ü–æ–∂–∞–ª—É–π—Å—Ç–∞|–†–æ—Å—Å–∏—è|¬©|$)/i);
      const senderBlock = senderMatch ? senderMatch[2].trim().replace(/\n/g, ' ') : '';
      const companyMatch = senderBlock.match(/^([^,]+)/);
      const company = companyMatch ? companyMatch[1].trim() : '';
      const innMatch = senderBlock.match(/–ò–ù–ù\s*([*\d]+)/);
      const inn = innMatch ? innMatch[1] : '';
      const rsMatch = senderBlock.match(/—Ä\/—Å\s*([*\d]+)/i);
      const rs = rsMatch ? rsMatch[1] : '';

      /*******************
       * 3.4 –î–æ–≥–æ–≤–æ—Ä –∏ –¥–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞
       *******************/
      const docMatch = body.match(/(–°—á–µ—Ç[–∞—É-]*–¥–æ–≥–æ–≤–æ—Ä[–∞—É]*|–¥–æ–≥–æ–≤–æ—Ä[–∞—É]*)\s*‚Ññ\s*([\d\-]+)\s*–æ—Ç\s*([\d\.]+)/i);
      const docNum = docMatch ? docMatch[2] : '';
      const docDate = docMatch ? docMatch[3] : '';

      /*******************
       * 3.5 –°—É–º–º–∞ (–∫–∞–∫ —á–∏—Å–ª–æ, —Å–æ –∑–Ω–∞–∫–æ–º)
       *******************/
      const amountMatch = body.match(/([+-]?\s*[\d\s]+(?:,\d{2})?)\s*RUB/i);
      let amount = amountMatch ? amountMatch[1].replace(/[^\d,-]/g, '') : '';
      amount = amount.replace(',', '.');
      const numAmount = parseFloat(amount) || 0;
      const signedAmount = (body.includes('—Å–ø–∏—Å–∞–Ω—ã —Å—Ä–µ–¥—Å—Ç–≤–∞') || body.includes('–°–ø–∏—Å–∞–Ω–∏–µ') || body.includes('—Å–ø–∏—Å–∞–Ω—ã'))
        ? -numAmount : numAmount;

      /*******************
 /*******************
 * 3.6 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—á–∏—Å—Ç–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
 *******************/
const purposeMatch = body.match(/–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:\s*([\s\S]*?)(?:–ü–æ–∂–∞–ª—É–π—Å—Ç–∞|–†–æ—Å—Å–∏—è|¬©|$)/i);
let purpose = purposeMatch ? purposeMatch[1].trim().replace(/\n/g, ' ') : '';

purpose = purpose
  // --- –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–º–µ–Ω—ã ---
  .replace(/–ü–µ—Ä–µ–≤–æ–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ –ò–ü –Ω–∞ –ª–∏—á–Ω—ã–π —Å—á–µ—Ç/gi, '–ò–ü ‚û°Ô∏è –õ–°')
  .replace(/–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ —Å–æ —Å—á–µ—Ç–∞ –Æ–õ –Ω–∞ —Å—á–µ—Ç–∞ –§–õ, –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤ –ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫[^.]*\./gi, '–ö–æ–º–∏—Å—Å–∏—è –ò–ü ‚û°Ô∏è –õ–°')
  // --- –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤ ---
  .replace(/–ö–æ–º–∏—Å—Å–∏—è –∑–∞ —É—Å–ª—É–≥—É\s*["¬´]–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º —Å—á–µ—Ç–∞–º –≤ –≤–∞–ª—é—Ç–µ –†–§["¬ª][^0-9]*(\d{2})\.(\d{2})\.\d{4}[^0-9]*(\d{2})\.(\d{2})\.\d{4}/gi,
    (m, d1, m1, d2, m2) => {
      const month = (m1 === m2)
        ? getMonthNameRu(parseInt(m1, 10))
        : `${getMonthNameRu(parseInt(m1, 10))}-${getMonthNameRu(parseInt(m2, 10))}`;
      return `–ö–æ–º–∏—Å—Å–∏—è "–ò–Ω—Ñ–æ –æ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤" –∑–∞ ${month}`;
    })
  // --- –£–¥–∞–ª–µ–Ω–∏–µ —Ö–≤–æ—Å—Ç–æ–≤ –∏ –º—É—Å–æ—Ä–∞ ---
  .replace(/–ë–µ–∑ –Ω–∞–ª–æ–≥–∞\s*\(–ù–î–°\)/gi, '')
  .replace(/–ë–ï–ó –ù–ê–õ–û–ì–ê\s*\(–ù–î–°\)/gi, '')
  .replace(/–í\.?\s*–¢\.?\s*–ß\.?\s*–ù–î–°\s*0%[^.,;]*/gi, '')
  .replace(/–ù–î–° –Ω–µ –æ–±–ª–∞–≥–∞–µ—Ç—Å—è/gi, '')
  .replace(/–ù–î–°\s*0%[^.,;]*/gi, '')
  .replace(/–î–æ–≥–æ–≤–æ—Ä[^.,;]*/gi, '')
  .replace(/–æ—Ç\s*\d{2}\.\d{2}\.\d{4}/gi, '')
  .replace(/[>]+/g, '')
  .replace(/\s{2,}/g, ' ')
  .replace(/\.\s*$/g, '')
  // --- —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–ª—É—á–∞–π–Ω—ã—Ö —Ö–≤–æ—Å—Ç–æ–≤ ---
  .replace(/(–ò–ü ‚û°Ô∏è –õ–°).*/i, '–ò–ü ‚û°Ô∏è –õ–°')
  .replace(/(–ö–æ–º–∏—Å—Å–∏—è –ò–ü ‚û°Ô∏è –õ–°).*/i, '–ö–æ–º–∏—Å—Å–∏—è –ò–ü ‚û°Ô∏è –õ–°')
  .replace(/(–ö–æ–º–∏—Å—Å–∏—è "–ò–Ω—Ñ–æ –æ –¥–≤–∏–∂–µ–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤" –∑–∞ [–∞-—è\-]+)/i, (m) => m.trim())
  .trim();

/*******************
 * –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
 *******************/
function getMonthNameRu(num) {
  const months = ['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];
  return months[num - 1] || '';
}


      /*******************
       * 3.7 –ë–∞–ª–∞–Ω—Å
       *******************/
      const balanceMatch = body.match(/–ë–∞–ª–∞–Ω—Å —Å—á[–µ—ë]—Ç–∞[^:]*:\s*([\d\s]+,\d{2})\s*RUB/i);
      let balance = balanceMatch ? balanceMatch[1].replace(/\s+/g, '') : '';
      balance = balance.replace(',', '.');

      /*******************
       * 3.8 –ó–∞–ø–∏—Å—å —Å—Ç—Ä–æ–∫–∏
       *******************/
      sh.insertRowBefore(2);
      sh.getRange(2, 1, 1, 10).setValues([[
        dateStr, type, company, inn, rs, docNum, docDate, signedAmount, purpose, balance
      ]]);
    }
  }
}