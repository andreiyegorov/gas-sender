/*******************************************************
 *  ğŸ“¨ SENDER INVITE â€” Ğ»Ğ¾Ğ²ĞµÑ† CSV-Ğ¿Ñ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğ¹
 *  Ğ’ĞµÑ€ÑĞ¸Ñ: 2025-11
 *******************************************************/


/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * 1. ĞšĞĞĞ¡Ğ¢ĞĞĞ¢Ğ« (Ğ¼ĞµÑ‚ĞºĞ°, Ğ¸Ğ¼ĞµĞ½Ğ° Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
var INVITE_LABEL_NAME = 'sender_fetcher_newlinks';
var LINKS_SHEET_NAME = 'Links';
var LOG_SHEET_NAME = 'received-log';



/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * 2. ĞĞ‘Ğ•Ğ Ğ¢ĞšĞ Ğ”Ğ›Ğ¯ ĞœĞ•ĞĞ®
 *    (Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµÑ‚ ĞºÑ€Ğ¾Ğ¼Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° senderInvite_)
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function senderInviteCheck() {
  senderInvite_('menu-check');
}



/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * 3. ĞĞ¡ĞĞĞ’ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ (Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¾Ğ¼)
 *    â€” Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¸ÑĞµĞ¼
 *    â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹
 *    â€” Ñ€Ğ°Ğ·Ğ±Ğ¾Ñ€ CSV
 *    â€” Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Links
 *    â€” Ğ»Ğ¾Ğ³ Ğ² received-log
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
function senderInvite_(source) {

  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var tz = Session.getScriptTimeZone();
  var now = new Date();
  var nowStr = Utilities.formatDate(now, tz, 'dd.MM.yy HH.mm');



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.1 Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¸ÑÑ‚Ğ° Links
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  var sheetLinks = ss.getSheetByName(LINKS_SHEET_NAME);
  if (!sheetLinks) {
    sheetLinks = ss.insertSheet(LINKS_SHEET_NAME);
    sheetLinks.appendRow([
      'Email TS',
      'Check TS',
      'Group Name',
      'User ID',
      'Password'
    ]);
  }



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.2 Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¸ÑÑ‚Ğ° received-log
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  var logSheet = ss.getSheetByName(LOG_SHEET_NAME);
  if (!logSheet) {
    logSheet = ss.insertSheet(LOG_SHEET_NAME);
    logSheet.appendRow([
      'Timestamp','Source','File','Rows added','Status','Error'
    ]);
  }



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.3 ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚ĞºÑƒ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ²
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  var label = GmailApp.getUserLabelByName(INVITE_LABEL_NAME) || GmailApp.createLabel(INVITE_LABEL_NAME);



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.4 Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (Ğ»ÑĞ±Ğ¾Ğ¹ email Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼)
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  var searchQuery = [
    'in:inbox',
    'newer_than:30d',
    'has:attachment'
  ].join(' ');

  var threads = GmailApp.search(searchQuery);



  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.5 Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¸ÑĞµĞ¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  for (var t = 0; t < threads.length; t++) {

    var thread = threads[t];

    // Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ, ĞµÑĞ»Ğ¸ Ğ¼ĞµÑ‚ĞºĞ° ÑƒĞ¶Ğµ ÑÑ‚Ğ¾Ğ¸Ñ‚
    if (thread.getLabels().some(function(l){return l.getName()===INVITE_LABEL_NAME;})) continue;

    var msgs = thread.getMessages();



    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * 3.6 Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ¸
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    for (var m = 0; m < msgs.length; m++) {

      var msg = msgs[m];
      var dateStr = Utilities.formatDate(msg.getDate(), tz, 'dd.MM.yy HH.mm');
      var atts = msg.getAttachments();
      if (!atts || atts.length === 0) continue;



      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       * 3.7 Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹, Ğ¿Ğ¾Ğ¸ÑĞº CSV
       * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       */
      for (var a = 0; a < atts.length; a++) {

        var att = atts[a];
        var filename = att.getName();

        // Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ CSV
        if (!att.getContentType().match(/csv/i) && !filename.match(/\.csv$/i)) continue;



        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * 3.8 Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ CSV
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        var csv;
        try {
          csv = Utilities.parseCsv(att.getDataAsString());
        } catch(err) {
          logSheet.insertRowBefore(2);
          logSheet.getRange(2,1,1,6).setValues([[
            nowStr, source, filename, 0, 'âš ï¸ error', String(err)
          ]]);
          continue;
        }

        if (!csv || csv.length < 2) {
          logSheet.insertRowBefore(2);
          logSheet.getRange(2,1,1,6).setValues([[
            nowStr, source, filename, 0, 'âš ï¸ empty', ''
          ]]);
          continue;
        }



     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3.9 Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Links
   *     â€” Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº:
   *       1) Email TS (Ğ´Ğ°Ñ‚Ğ° Ğ¿Ğ¸ÑÑŒĞ¼Ğ°)
   *       2) Check TS (Ğ´Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸)
   *       3) Group Name
   *       4) User ID
   *       5) Password
   *     â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ñ€Ğ¾ĞºĞ¸, Ğ³Ğ´Ğµ ĞµÑÑ‚ÑŒ:
   *       â€¢ User ID
   *       â€¢ Password
   *     â€” Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¿Ğ¾ User ID
   *     â€” Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ÑÑ‚Ñ€Ğ¾Ğº Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ CSV: Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
   *     â€” Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ Ğ¿Ğ¾Ğ´ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº (Ğ² ÑÑ‚Ñ€Ğ¾ĞºÑƒ 2)
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   */
  var added = 0;

  for (var r2 = csv.length - 1; r2 >= 1; r2--) {

    var u2 = (csv[r2][0] || '').toString().trim();
    var p2 = (csv[r2][1] || '').toString().trim();
    var g2 = (csv[r2][2] || '').toString().trim();

    if (!u2 || !p2) continue;

    var exists = sheetLinks.createTextFinder(u2).matchCase(false).findNext();

    if (!exists) {
      sheetLinks.insertRowBefore(2);
      sheetLinks.getRange(2,1,1,5).setValues([[
        dateStr,   // Email TS
        nowStr,    // Check TS
        g2,
        u2,
        p2
      ]]);
      added++;
    }
  }



        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * 3.10 ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ¼ĞµÑ‚ĞºÑƒ Ğ½Ğ° Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        thread.addLabel(label);



        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         * 3.11 Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³
         * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         */
        logSheet.insertRowBefore(2);
        logSheet.getRange(2,1,1,6).setValues([[
          nowStr, source, filename, added, 'âœ… received', ''
        ]]);

      }
    }
  }
}